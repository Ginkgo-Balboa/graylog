user                            www-data;
worker_processes                auto;
load_module                     /usr/lib/nginx/modules/ngx_stream_module.so;
error_log                       /var/log/nginx/error.log warn;
pid                             /var/run/nginx.pid;
events
{
    worker_connections  1024;
}

http
{
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;
    log_format main     '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

    access_log          /var/log/nginx/access.log  main;
    sendfile            on;
    keepalive_timeout   65;
    include             /etc/nginx/conf.d/*.conf;
}

stream
{

######################################################################
#                         NO TLS INPUTS                              #
######################################################################

    # Upstream for syslog UDP
    upstream graylog_syslog_udp
    {
        server graymongo1.nerd.mooc:1514 max_fails=3 fail_timeout=30s;
        server graymongo2.nerd.mooc:1514 max_fails=3 fail_timeout=30s;
        server graymongo3.nerd.mooc:1514 max_fails=3 fail_timeout=30s;
    }
    server
    {
        listen 1514 udp;
        proxy_pass graylog_syslog_udp;
        proxy_timeout 10s;
        
        error_log /var/log/nginx/graylog_syslog_udp.log;
    }
######################################################################
    # Upstream for syslog TCP
    upstream graylog_syslog_tcp
    {
        server graymongo1.nerd.mooc:10514 max_fails=3 fail_timeout=30s;
        server graymongo2.nerd.mooc:10514 max_fails=3 fail_timeout=30s;
        server graymongo3.nerd.mooc:10514 max_fails=3 fail_timeout=30s;
    }
    server
    {
        listen 10514;
        proxy_pass graylog_syslog_tcp;
        proxy_timeout 3600s;
        
        error_log /var/log/nginx/graylog_syslog_tcp.log;
    }
######################################################################    
    # Upstream for Beats
    upstream graylog_beats
    {
        server graymongo1.nerd.mooc:5044 max_fails=3 fail_timeout=30s;
        server graymongo2.nerd.mooc:5044 max_fails=3 fail_timeout=30s;
        server graymongo3.nerd.mooc:5044 max_fails=3 fail_timeout=30s;    
    }
    server
    {
        listen 5044;
        proxy_pass graylog_beats;
        proxy_timeout 3600s;
        error_log /var/log/nginx/graylog_beats.log;
    }
######################################################################
#                           TLS INPUTS                               #
######################################################################

    # Upstream for syslog TLS
    upstream graylog_syslog_tls
    {
        server graymongo1.nerd.mooc:20514 max_fails=3 fail_timeout=30s;
        server graymongo2.nerd.mooc:20514 max_fails=3 fail_timeout=30s;
        server graymongo3.nerd.mooc:20514 max_fails=3 fail_timeout=30s;
    }
    server
    {
        listen 20514 tls;
        proxy_pass graylog_syslog_tls;
        proxy_timeout 3600s;
        
        error_log /var/log/nginx/graylog_syslog_tls.log;
        
        ssl_certificate         /etc/nginx/certificates/niam-cert.pem;
        ssl_certificate_key     /etc/nginx/certificates/niam-key.pem;
    }
######################################################################    
    # Upstream for Beats
    upstream graylog_beats_tls
    {
        server graymongo1.nerd.mooc:25044 max_fails=3 fail_timeout=30s;
        server graymongo2.nerd.mooc:25044 max_fails=3 fail_timeout=30s;
        server graymongo3.nerd.mooc:25044 max_fails=3 fail_timeout=30s;    
    }
    server
    {
        listen 25044 ssl;
        proxy_pass graylog_beats_tls;
        proxy_timeout 3600s;
        
        error_log /var/log/nginx/graylog_beats_tls.log;

        ssl_certificate         /etc/nginx/certificates/graylog-cert.pem;
        ssl_certificate_key     /etc/nginx/certificates/graylog-key.pem;
    }
}
